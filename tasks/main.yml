---
# @TODO: replace the Makefile with real ansible tasks
- name: Check for tmp directory.
  stat:
    path: /tmp
  register: temp_folder

- name: Create a temporary dir on the host
  tempfile:
    state: directory
  register: remote_tempdir_result
  when: temp_folder.stat.exists == false

- name: Sync local scripts to the remote temp dir
  synchronize:
    src: "scripts/"
    dest: "{{ remote_tempdir_result.path }}/"
    recursive: true
    rsync_opts:
      - "--exclude=.git"
  when: remote_tempdir_result is defined
    and remote_tempdir_result.path is defined
  register: upload_result

- name: Run '{{ make_cmd }}' in the remote temp dir
  shell: "{{ make_cmd }}"
  args:
    chdir: "{{ remote_tempdir_result.path }}/"
  when: upload_result is defined
    and upload_result.changed
